{"componentChunkName":"component---src-templates-blog-post-js","path":"/azurearc_auth/","result":{"data":{"site":{"siteMetadata":{"title":"Aparna's Personal Space","author":"Aparna Ravindra"}},"markdownRemark":{"id":"285e723e-608f-5bcb-a613-83e4ae70da47","excerpt":"I recently ran into a situation where I couldn’t use the usual  magic from the  library to authenticate my .NET app to Azure. I had to manually generate a token…","html":"<p>I recently ran into a situation where I couldn’t use the usual <code class=\"language-text\">DefaultAzureCredential</code> magic from the <code class=\"language-text\">Azure.Identity</code> library to authenticate my .NET app to Azure. I had to manually generate a token and include it in the HTTP request header. That’s when I discovered something interesting—<strong>Arc-enabled servers have a slightly different authentication mechanism compared to Azure VMs</strong>.</p>\n<p>This post is a quick walkthrough of what I learned, how Arc-enabled servers handle managed identity, and how it all works under the hood.</p>\n<hr>\n<h2>Azure VMs: The Classic Case</h2>\n<p>When your app runs on an Azure VM with a system-assigned or user-assigned managed identity, Azure injects a local endpoint into the VM (usually at <code class=\"language-text\">http://169.254.169.254/metadata/identity/oauth2/token</code>). This endpoint is backed by the Azure Instance Metadata Service (IMDS), which handles token issuance.</p>\n<p>Your app (or the <code class=\"language-text\">Azure.Identity</code> library) makes a request to this endpoint, and voila—you get a token scoped to the resource you asked for (like Azure Key Vault or Azure Resource Manager).</p>\n<hr>\n<h2>Arc-Enabled Servers: The Hybrid Twist</h2>\n<p>Arc-enabled servers are <em>not</em> running inside Azure. They could be on-prem, in another cloud, or even under your desk. So how do they authenticate using managed identity?</p>\n<p>Here’s the trick: Arc-enabled servers use a <strong>local agent</strong> that acts as a bridge between your machine and Azure. When you enable system-assigned managed identity on an Arc server, the agent:</p>\n<ol>\n<li>Registers the server with Azure AD.</li>\n<li>Sets up a local token service (similar to IMDS, but not the same).</li>\n<li>Handles token requests from your app.</li>\n</ol>\n<p>The local endpoint is usually at <code class=\"language-text\">http://localhost:40342/metadata/identity/oauth2/token</code> (discover it using $env:IDENTITY_ENDPOINT), and it behaves similarly to the Azure VM IMDS endpoint—but under the hood, it’s the Arc agent doing the heavy lifting.</p>\n<hr>\n<h2>The Challenge-Response Dance</h2>\n<p>Unlike Azure VMs, where the token endpoint is always trusted, Arc-enabled servers add an extra layer of security using a <strong>challenge-response mechanism</strong>.</p>\n<p>Here’s how it works:</p>\n<ol>\n<li>Your app sends a request to the local Arc token endpoint.</li>\n<li>The Arc agent responds with a <code class=\"language-text\">401 Unauthorized</code> and includes a <code class=\"language-text\">WWW-Authenticate</code> header (something like <code class=\"language-text\">Basic realm=KEY_FILE_PATH</code>).</li>\n<li>This header contains a path to a <strong>secret key file</strong> on disk (usually something like <code class=\"language-text\">C:\\ProgramData\\AzureConnectedMachineAgent\\Tokens\\8af777f4-2190-4b12-aafc-2543e26b4a7f.key</code>).</li>\n<li>Your app (or the <code class=\"language-text\">Azure.Identity</code> library) reads the file, extracts the secret, and resends the request—this time with the secret in the <code class=\"language-text\">Authorization</code> header.</li>\n<li>The Arc agent validates the secret and returns the access token.</li>\n</ol>\n<p>This mechanism ensures that only processes running on the machine (with access to the file system) can request tokens—adding a layer of local trust.</p>\n<hr>\n<h2>Why Should You Care?</h2>\n<p>If you're using <code class=\"language-text\">DefaultAzureCredential</code>, you might not need to care—because it already knows how to detect and use the right endpoint, whether you're on a VM, Arc server, or even in GitHub Actions.</p>\n<p>But if you're curious (like me), it's fascinating to see how Azure extends its identity model to hybrid environments. It’s also useful when debugging or building custom tooling that interacts with these endpoints directly.</p>\n<p>For more details, check out the official docs on <a href=\"https://learn.microsoft.com/en-us/azure/azure-arc/servers/managed-identity-authentication\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Managed identity authentication on Arc-enabled servers</a>!</p>","fields":{"slug":"/azurearc_auth/"},"frontmatter":{"title":"Authentication in Azure Arc-Enabled Servers","date":"2025, Oct 02","tags":["tech"],"memorydata":null,"practicedata":null,"img":{"childImageSharp":{"resize":{"src":"/static/f1d71e1472b70f5a2bce37a1c6096f9c/f3583/arc_auth.png","height":800,"width":1200},"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSUlEQVQoz2WSS3PSUBTHu3X8DrrzA+hSP4Ku3Dije1cudOFG7UJdyMKuXDDqWHzUwqCApQyPFgqUYnhDAoGQQiQhyQ3PPKHJ5eHwGFpx5szce8+9v3Pn/P9noykZi6BFnVOgoI1ZGQqDCadATl4egTpuSgYrQ0Y0Vu+bkrGxWNj5nTWIffPnrUHUFsLsR0XbfPPVn/MgpAchwyjdHk4YUV+HGVFPVsHeCfEzUnJESx6EtIWwX7GK67i8G0QD6fphlgqk62VO5hS44pcwr0B3nHDFyhGUdser3w8KZieyE8h7k6e2EGYLYY4obj8qhlFa0MbrcKHRy9Y7ZVbKUZ0s1aH7uqCNeRXy6gioI3k85RUjRQqkoPLq6BxmZUh1h66TSqbWsnizsRIbyNQTBJiLpFPdQaN39mE//XL7IIazgQxVFVROhkuYUyApaHmqRQLx4ZsfFl+uPYCJKmAlAyFAFSi/CXD9vunGA5M9gpeaYiBDtQZL2ZY/f/blPnkyZlfixXv/tjeDEKDCyx/3UrWWlqgK1+6+unpnc8t6nCKFUrM/02zVM6fALVvs0VvHldub955/efpuH6P7JFDq7UHnbBqv8JduPr5868luCJNG04U154IxotE3po3e0LQT9qVqEpyuuuKVUZHpv7YEn5m9MZxlRONPd/iPz5wCy5zsjOIRlPYmT8MoDeZ+MKIOtHGCAOF8I1xoOCO4M4qXOWlu9QWrZiVkOJtQGXIKXCUZURe0CVLh3XHiMEutDenGxVldtLCWmQOz+D//F+FlnCD+jHAlAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/6e90d/arc_auth.png","srcSet":"/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/ea847/arc_auth.png 750w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/4a806/arc_auth.png 1080w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/e2aad/arc_auth.png 1366w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/6e90d/arc_auth.png 1536w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/b0356/arc_auth.avif 750w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/48f75/arc_auth.avif 1080w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/a5094/arc_auth.avif 1366w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/b30f5/arc_auth.avif 1536w","type":"image/avif","sizes":"100vw"},{"srcSet":"/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/57584/arc_auth.webp 750w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/984df/arc_auth.webp 1080w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/4a276/arc_auth.webp 1366w,\n/blog/static/f1d71e1472b70f5a2bce37a1c6096f9c/7db9c/arc_auth.webp 1536w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}}}}},"pageContext":{"slug":"/azurearc_auth/","previous":{"fields":{"slug":"/startwithwhy/"},"frontmatter":{"title":"Start With Why","tags":["book","non-fiction"],"img":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDAv/EABcBAAMBAAAAAAAAAAAAAAAAAAABAwT/2gAMAwEAAhADEAAAAbzqs9tDEf/EABsQAAIBBQAAAAAAAAAAAAAAAAECABAREiEy/9oACAEBAAEFArx2YFecdlQaf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAQACAwAAAAAAAAAAAAAAAAABIRARsf/aAAgBAQAGPwJXENrx/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFBYf/aAAgBAQABPyF17AAukJUesQi3JW6z7Aoqf//aAAwDAQACAAMAAAAQGP8A/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QRn//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxASf//EAB0QAQEAAgEFAAAAAAAAAAAAAAERADEhQVFhocH/2gAIAQEAAT8QSOp7aMEEaNtPPzERoVZPWXQOUJnn5kRgENBDP//Z"},"images":{"fallback":{"src":"/blog/static/812feb84a640a5091f0418982a938469/83638/startwithwhy.jpg","srcSet":"/blog/static/812feb84a640a5091f0418982a938469/7284f/startwithwhy.jpg 750w,\n/blog/static/812feb84a640a5091f0418982a938469/29ba9/startwithwhy.jpg 1080w,\n/blog/static/812feb84a640a5091f0418982a938469/c8896/startwithwhy.jpg 1366w,\n/blog/static/812feb84a640a5091f0418982a938469/83638/startwithwhy.jpg 1536w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/812feb84a640a5091f0418982a938469/57584/startwithwhy.webp 750w,\n/blog/static/812feb84a640a5091f0418982a938469/984df/startwithwhy.webp 1080w,\n/blog/static/812feb84a640a5091f0418982a938469/4a276/startwithwhy.webp 1366w,\n/blog/static/812feb84a640a5091f0418982a938469/7db9c/startwithwhy.webp 1536w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}}}},"next":null}},"staticQueryHashes":["251720178","764694655"]}