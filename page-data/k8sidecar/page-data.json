{"componentChunkName":"component---src-templates-blog-post-js","path":"/k8sidecar/","result":{"data":{"site":{"siteMetadata":{"title":"Aparna's Personal Space","author":"Aparna Ravindra"}},"markdownRemark":{"id":"9661a927-09fc-5605-8cd2-e76101943e0d","excerpt":"Have you ever had two containers in the same Pod, but one absolutely needed to be running before the other could start? That was my situation with a workload in…","html":"<p>Have you ever had two containers in the same Pod, but one absolutely needed to be running before the other could start?</p>\n<p>That was my situation with a workload in Kubernetes:</p>\n<ul>\n<li>Container A consumed logs to export to an external system using a custom exe.</li>\n<li>Container B generated business logic that generates the logs.</li>\n</ul>\n<p>Container A needed a non-deterministic time to authenticate to the external system and start the log consumption service. If B started too early, logs were lost.</p>\n<hr>\n<h2>What Didn’t Work</h2>\n<ul>\n<li>Running two containers in the same pod does not guarantee the order of container creation.</li>\n<li>Using a regular initContainer → runs to completion, then exits. Not what I needed.</li>\n<li>Adding sleeps or custom wait scripts in Container B → fragile and hard to maintain.</li>\n</ul>\n<p>I wanted something <em>native, reliable, and maintainable</em>.</p>\n<hr>\n<h2>The Solution: Init Container with restartPolicy: Always</h2>\n<p>Kubernetes provides a neat trick:</p>\n<ul>\n<li>Declare the dependency container as an <em>initContainer</em>.</li>\n<li>Set restartPolicy: Always to keep it running alongside other containers. This concept is called a <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">\"sidecar\"</a>.</li>\n<li>Add a <em>startupProbe</em> to the initcontainer to ensure the log consumption process is ready before the main container starts.</li>\n</ul>\n<p>This approach works across Linux and Windows containers, though it’s especially helpful for Windows workloads where traditional shell-based probes or scripting hacks are harder.</p>\n<hr>\n<h2>YAML Example</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sampledeployment\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span> \n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate\n    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">maxSurge</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> sample\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">initContainers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sidecar\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> __SIDECAR_IMAGE_NAME__ <span class=\"token comment\">#replaced at runtime</span>\n        <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Always <span class=\"token comment\">#MAGIC</span>\n        <span class=\"token key atrule\">startupProbe</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n          <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n          <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n          <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> powershell\n              <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>Command\n              <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n                $process = Get-Process -Name \"logconsumptionservice\" -ErrorAction SilentlyContinue\n                if ($process) { exit 0 } else { exit 1 }</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> __MAIN_IMAGE_NAME__ <span class=\"token comment\">#replaced at runtime</span>\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> \n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"300m\"</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"500Mi\"</span>\n          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"400m\"</span>\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"600Mi\"</span></code></pre></div>\n<p>In this example, the \"sidecar\" container is started first because it is an <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/init-containers/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">\"init container\"</a>. The main container is not started until the <a href=\"https://kubernetes.io/docs/concepts/configuration/liveness-readiness-startup-probes/#startup-probe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">\"startup probe\"</a> returns a success. However, it checks only 10 times before failing the pod instead of waiting forever for the initcontainer to be started.\nThe magic ingredient here is the \"restartPolicy\" that continues to run the initcontainer as a sidecar. This is different from the normal behaviour where the initcontainer runs to completion.</p>\n<p>Note that the main container is not even started (even the image is not pulled) until the init container is started successfully. This provides \"true\" sequence of execution.</p>\n<p>Word of caution: Ensure that the sidecar feature is available for your K8 version.</p>\n<h2>So what if my K8 version does not support sidecars?</h2>\n<p>I was also exploring ways to ensure process start sequence across two containers where sidecars are not available. The quick and dirty way to make this happen is to give a signal in Container A (log consumer) that the process is ready and wait for the signal in Container B (log generator) before starting the process. This way, you can allow K8 to download the images for the container and go ahead with the \"entry point\" code without having to wait. However, this is not clean code because the log generator needs to be aware of the container A.\nIf you really need to go this route, consider using <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">\"postStart event\"</a> to wait for the log consumer service to start and then create signal. The signal can be something as crude as a file in a common mounted volume between both the containers.</p>","fields":{"slug":"/k8sidecar/"},"frontmatter":{"title":"How I fixed Startup-Order Problem in Kubernetes (with Windows Containers)","date":"2025, Sep 26","tags":["tech"],"memorydata":null,"practicedata":null,"img":{"childImageSharp":{"resize":{"src":"/static/617d862b165f6564fdc0c554bf2ae652/f3583/sidecar.png","height":800,"width":1200},"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACnklEQVQoz2VR30tTYRjeX9FF5s52vmO5ZEaFFgQVK02lxMQyNKSLQOdFOzs/nDs6ZqlrOtc2dQmhRqmoxSQy+nFTOQq6qZXzfN/Z+bG5M1czEKKLLropjlMxgpfvfeB9n+993ufVAQbmA7PzejtvoPgCG5/H+0i+kOT1dqi3w8LtKmARYHiNwiJdPuE0PN6TON0vlruF2jvyyT6x0itW+ySLR7R4xLNeqWpQOnNbLHMnDORnzLqEWaM4tawDdBzQcYyC5MPVvoVM20RqOppzzqq9kczIi6/+xWxvJNMUVtiZdF8k0zqxipFfcDJmJGM4Fddh1qi+7Y3R9qnYIRxxCZeHleZw8vp4qimsXBlVanxyczhZH1RaxpJVg5KZQ4BBmnJWAAzSASqOU8uAigMGFtj45rtJ16O0+3GGm1O5ObV1POV9snYzorrm1Qt+ee8NvoiFWzszUKf9tImMNH/iVqIhpJwbkMycUOJEh7sFcxcqYqHJAQ92wv0sNNKQ0Mhoh7zldl1AvhSSr4aV+qBcF5CLWGigYIkTlXLI4hGbRpWqAallLHnUJWBknNghG2lY2oVq/ZJzVp18/a17Xq0Pyoe6hAMd0DqZar+fqhmShp9nA8/Wrt1L7bF+NFqXcDKmnYpgtRtaPGLlgDS0mH0V+z76MlvhlS4G5Zlobn3j55/fvx68zVFT6bn3uRqfpCdXCGoZ0Cu7JnOo1i+f98vcvFoXkKt9UoVXml7KvYMbcvaH72m2cURZ+LDeOKIYqH93Jliot/PlPUJDSD7Vn2gIycd6EsUO2D65anIgM4dMDlTmFqipNGAgvu0RoLcNIxhooHhTh+awqVPDBAsxijfSmi4DzRObPYCG4H8yoLUaTmkO45s4r4jIvyzcmQF2xV/FW6J9Dt7h2wAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/blog/static/617d862b165f6564fdc0c554bf2ae652/6e90d/sidecar.png","srcSet":"/blog/static/617d862b165f6564fdc0c554bf2ae652/ea847/sidecar.png 750w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/4a806/sidecar.png 1080w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/e2aad/sidecar.png 1366w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/6e90d/sidecar.png 1536w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/617d862b165f6564fdc0c554bf2ae652/b0356/sidecar.avif 750w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/48f75/sidecar.avif 1080w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/a5094/sidecar.avif 1366w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/b30f5/sidecar.avif 1536w","type":"image/avif","sizes":"100vw"},{"srcSet":"/blog/static/617d862b165f6564fdc0c554bf2ae652/57584/sidecar.webp 750w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/984df/sidecar.webp 1080w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/4a276/sidecar.webp 1366w,\n/blog/static/617d862b165f6564fdc0c554bf2ae652/7db9c/sidecar.webp 1536w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6666666666666666}}}}}},"pageContext":{"slug":"/k8sidecar/","previous":{"fields":{"slug":"/leanin/"},"frontmatter":{"title":"Lean In","tags":["book","non-fiction"],"img":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQCBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB6eZdaxanJQJNA//EABoQAQADAQEBAAAAAAAAAAAAAAEAAhESAxP/2gAIAQEAAQUC+lY+plXYARaSupzWckwn/8QAFREBAQAAAAAAAAAAAAAAAAAAESD/2gAIAQMBAT8BI//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EAB0QAAMAAAcAAAAAAAAAAAAAAAABMQIQESFBkbH/2gAIAQEABj8Ce8NcmsXpH2cEIQ//xAAdEAEBAAICAwEAAAAAAAAAAAABEQAhUXEQMUGB/9oACAEBAAE/IUDZywOxnWCaP3E6PbowWSuCxhLzm6zevGCIA/M//9oADAMBAAIAAwAAABBnD8P/xAAWEQEBAQAAAAAAAAAAAAAAAAABABD/2gAIAQMBAT8QDIb/AP/EABYRAQEBAAAAAAAAAAAAAAAAAAAREP/aAAgBAgEBPxBFz//EABwQAQEAAgMBAQAAAAAAAAAAAAERACExQWFRcf/aAAgBAQABPxBl7IJ35lHCR7O8WhZHEyNq6GatPV3iVBcKZv8ATzChSARYfZiyVXKQ59Q/u8HBjoGf/9k="},"images":{"fallback":{"src":"/blog/static/e0bb35cf00b1711448a150ba97eee7b2/24f4c/leanin.jpg","srcSet":"/blog/static/e0bb35cf00b1711448a150ba97eee7b2/0f5ce/leanin.jpg 750w,\n/blog/static/e0bb35cf00b1711448a150ba97eee7b2/24f4c/leanin.jpg 1024w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/e0bb35cf00b1711448a150ba97eee7b2/4f03f/leanin.webp 750w,\n/blog/static/e0bb35cf00b1711448a150ba97eee7b2/67ded/leanin.webp 1024w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}}}},"next":null}},"staticQueryHashes":["251720178","764694655"]}