{"componentChunkName":"component---src-templates-blog-post-js","path":"/concurrency_and_csharp/","result":{"data":{"site":{"siteMetadata":{"title":"Aparna's Personal Space","author":"Aparna Ravindra"}},"markdownRemark":{"id":"74ac57d4-7704-5c13-9ba2-99f8daf906fc","excerpt":"Recently, I gave a talk at work titled . Naturally, I spent a lot of time reading blogs and books about this topic. Here is my attempt to retain some of thatâ€¦","html":"<p>Recently, I gave a talk at work titled <code class=\"language-text\">C# - Concurrency, Parallelism and Threads</code>. Naturally, I spent a lot of time reading blogs and books about this topic. Here is my attempt to retain some of that information for me to go refresh my concepts when needed.</p>\n<p>First, and the most important concept that we will need to remind ourselves is that <code class=\"language-text\">Concurrency</code> and <code class=\"language-text\">Parallelism</code> are not the same thing. Here is a screenshot to summarize this. The screenshot is borrowed from this pretty useful <a href=\"https://www.youtube.com/watch?v=8Je1W82vwYM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Youtube video</a> by Questpond.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 970px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/45687/concurrencyvsparallelism.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 95.06172839506173%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAIDBQEE/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2oqz0qxmwDoP/8QAGxAAAgMAAwAAAAAAAAAAAAAAAQIAERIhMTL/2gAIAQEAAQUCPdxfJYTXKsMsTqzNGf/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABcQAAMBAAAAAAAAAAAAAAAAAAABEDH/2gAIAQEABj8CrrNNP//EABsQAAICAwEAAAAAAAAAAAAAAAABETEhUZGB/9oACAEBAAE/IX2j0bVno0o2SEcDTojC9O2TOwtg/9oADAMBAAIAAwAAABCXwAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAdEAEAAwEAAgMAAAAAAAAAAAABABEhQTFRYcHw/9oACAEBAAE/EFWWBRzcs2DoJ5me45Smt24YzvV2LSW39J+D7jedVT8sVLwrw1yBMh//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/fc615/concurrencyvsparallelism.avif 243w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/b3175/concurrencyvsparallelism.avif 485w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/006d3/concurrencyvsparallelism.avif 970w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/f6ed8/concurrencyvsparallelism.avif 1262w\"\n              sizes=\"(max-width: 970px) 100vw, 970px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/0e3e2/concurrencyvsparallelism.webp 243w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/749af/concurrencyvsparallelism.webp 485w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/dbca2/concurrencyvsparallelism.webp 970w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/24091/concurrencyvsparallelism.webp 1262w\"\n              sizes=\"(max-width: 970px) 100vw, 970px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/3f316/concurrencyvsparallelism.jpg 243w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/0d3a1/concurrencyvsparallelism.jpg 485w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/ec7ce/concurrencyvsparallelism.jpg 970w,\n/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/45687/concurrencyvsparallelism.jpg 1262w\"\n            sizes=\"(max-width: 970px) 100vw, 970px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/e7c22fd4daf0d647856a0b3dfbb8839a/ec7ce/concurrencyvsparallelism.jpg\"\n            alt=\"Concurrency Vs Parallelism\"\n            title=\"Concurrency Vs Parallelism\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Concurrency is when you have multiple tasks in progress. Note that these tasks need to be independent and can be executed in any order. Concurrency is the concept - it is how you break down your problem into sub-problems that are independent of each other. <a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Here</a> is a C# example from Microsoft for breaking down problems and using C# libraries to execute them concurrently.</p>\n<p>** Synchronous problem solving **</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">static void Main(string[] args)\n{\n    Coffee cup = PourCoffee();\n    Console.WriteLine(&quot;coffee is ready&quot;);\n\n    Egg eggs = FryEggs(2);\n    Console.WriteLine(&quot;eggs are ready&quot;);\n\n    Bacon bacon = FryBacon(3);\n    Console.WriteLine(&quot;bacon is ready&quot;);\n\n    Toast toast = ToastBread(2);\n    ApplyButter(toast);\n    ApplyJam(toast);\n    Console.WriteLine(&quot;toast is ready&quot;);\n\n    Juice oj = PourOJ();\n    Console.WriteLine(&quot;oj is ready&quot;);\n    Console.WriteLine(&quot;Breakfast is ready!&quot;);\n}\n</code></pre></div>\n<p>** Concurrent problem solving **</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">static async Task Main(string[] args)\n{\n    Coffee cup = PourCoffee();\n    Console.WriteLine(&quot;coffee is ready&quot;);\n\n    var eggsTask = FryEggsAsync(2);\n    var baconTask = FryBaconAsync(3);\n    var toastTask = MakeToastWithButterAndJamAsync(2);\n\n    var eggs = await eggsTask;\n    Console.WriteLine(&quot;eggs are ready&quot;);\n\n    var bacon = await baconTask;\n    Console.WriteLine(&quot;bacon is ready&quot;);\n\n    var toast = await toastTask;\n    Console.WriteLine(&quot;toast is ready&quot;);\n\n    Juice oj = PourOJ();\n    Console.WriteLine(&quot;oj is ready&quot;);\n    Console.WriteLine(&quot;Breakfast is ready!&quot;);\n}</code></pre></div>\n<p>A word of caution! We have now solved the problem using concurrency. However, this can still be executed by a single thread (that is time splicing) on a single core. That means, we have not introduced <code class=\"language-text\">Parallel programming</code> yet. <a href=\"https://github.com/joshi-aparna/asp_thread_demo/blob/master/ThreadDemo/AsyncDemo.cs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Here</a> is my own version of the same problem that I used in the talk.</p>\n<p>Now, the decision to use parallel threads to execute these independent tasks is left to the <code class=\"language-text\">Common Language Runtime</code> or the <code class=\"language-text\">CLR</code>, which makes this decision depending on the operating system, the number of cores on the machine, etc. CLR maintains a thread pool that it puts to work when there are async operations to be performed. The size of the thread pool determines the parallelism of the program.</p>\n<p>CLR understands that having too many threads is not a good thing. Threads might end up spending so much time in context switching to do useful work. It uses two algorithms to ensure optimum number of threads.</p>\n<ol>\n<li>Starvation avoidance: Too many threads is a bad thing. However, if all the threads created so far are waiting for a new thread to be created and to wake them up, then CLR will create the new thread. The highest priority is to avoid starvation.</li>\n<li>Hill Climbing Heuristic: This is an algorithm that works on finding local maxima. The CLR keeps track of the number of threads, the number of completed tasks at all times. For a given sample time, it uses the Hill Climbing algorithm to determine what is the max thread count to get the highest throughput. If the max thread count advised is higher than the current thread count, then a new thread is created. Otherwise, the existing threads are killed once they complete their current tasks.</li>\n</ol>\n<p>CLR runs this algorithm every 500ms and every time a task is complete. I found a cool blog post <a href=\"https://mattwarren.org/2017/04/13/The-CLR-Thread-Pool-Thread-Injection-Algorithm/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a> that explains the algorithm in more detail. At the time of writing this, the \"managed\" threads created and maintained by the CLR has a 1-to-1 map to the kernel threads created by the operating system (<a href=\"https://github.com/dotnet/runtime/blob/main/docs/design/coreclr/botr/intro-to-clr.md#threading\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source</a>). However, this exists behind an abstraction and hence can change in the future.</p>\n<h4>Resources</h4>\n<ol>\n<li><a href=\"https://www.youtube.com/watch?v=8Je1W82vwYM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Concurrency vs Parallelism - Questpond</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=oV9rvDllKEg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Concurrency is not Parallelism by Rob Pike</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Asynchronous programming patterns - Microsoft</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Asynchronous programming with async and await - Microsoft</a></li>\n<li><a href=\"https://stackoverflow.com/a/33829420/3773974\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Understanding threads assignment in async/await</a></li>\n<li><a href=\"https://olegignat.com/task-wait-or-await-task/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Task Wait v/s Await</a></li>\n<li><a href=\"https://learning.oreilly.com/library/view/clr-via-c/9780735668737/ch27.html#how_worker_threads_are_managed\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How Worker Threads Are Managed</a></li>\n<li><a href=\"https://www.researchgate.net/publication/228977836_Optimizing_concurrency_levels_in_the_net_threadpool_A_case_study_of_controller_design_and_implementation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hill Climbing Concurrency Controller - Research paper</a></li>\n</ol>","fields":{"slug":"/concurrency_and_csharp/"},"frontmatter":{"title":"Concurrency and C#","date":"2022, Sep 18","tags":["tech","concurrency"],"memorydata":{"internal":{"content":"[\n    \"Concurrency is doing more than one thing at a time.\",\n    \"Multithreading is a form of concurrency that uses multiple threads of execution.\",\n    \"Parallel processing is doing lots of work by dividing it up among multiple threads that run concurrently.\",\n    \"Parallel processing is one type of multithreading, and multithreading is one type of concurrency.\",\n    \"Data parallelism is when you have a bunch of data items to process, and the processing of each piece of data is mostly independent from the other pieces.\",\n    \"Task parallelism is when you have a pool of work to do, and each piece of work is mostly independent from the other pieces.\",\n    \"Global Task Queue is used to manage the items with FIFO\",\n    \"If Worker threads enqueue work items they have their local queue for that and have access to head only LIFO. Hence Reversed execution.\",\n    \"Hill Climbing heuristic - to maximize throughput with fewer threads.\",\n    \"Hill Climbing algorithm advices to increase the thread count only if the CPU utilization is below 95%.\"\n]"}},"practicedata":null,"img":null}}},"pageContext":{"slug":"/concurrency_and_csharp/","previous":{"fields":{"slug":"/code_breaker/"},"frontmatter":{"title":"Code Breaker","tags":["tech","book","non-fiction"],"img":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAAB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQID/9oADAMBAAIQAxAAAAEukbeApcn/xAAbEAACAgMBAAAAAAAAAAAAAAABAgADERIhIv/aAAgBAQABBQI1loV8aRbGWKc18M//xAAXEQEAAwAAAAAAAAAAAAAAAAAAAQIS/9oACAEDAQE/AbNS/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8BJ//EABoQAAEFAQAAAAAAAAAAAAAAAAEAAhARIRL/2gAIAQEABj8CtrTSqMK6zDH/xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhMXH/2gAIAQEAAT8hQsfHmryjkXrmKw5bQekJd2VN/9oADAMBAAIAAwAAABB/P//EABYRAQEBAAAAAAAAAAAAAAAAAAEAIf/aAAgBAwEBPxAIZEf/xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8Qpkf/xAAdEAEBAAEEAwAAAAAAAAAAAAABEQAhMUFRcYGh/9oACAEBAAE/EHV1iOtdPfnGFw6lIhdsOiKYQIPeM2ix8ja1xVPV4mf/2Q=="},"images":{"fallback":{"src":"/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/76609/code_breaker.jpg","srcSet":"/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/36c9c/code_breaker.jpg 750w,\n/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/287ed/code_breaker.jpg 1080w,\n/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/21644/code_breaker.jpg 1366w,\n/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/76609/code_breaker.jpg 1488w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/38420/code_breaker.webp 750w,\n/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/5da49/code_breaker.webp 1080w,\n/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/b108a/code_breaker.webp 1366w,\n/blog/static/fd014a6699b6fd6dfd21a7e4774b85ee/bbd16/code_breaker.webp 1488w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6827956989247311}}}}},"next":null}},"staticQueryHashes":["251720178","764694655"]}