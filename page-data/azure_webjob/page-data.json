{"componentChunkName":"component---src-templates-blog-post-js","path":"/azure_webjob/","result":{"data":{"site":{"siteMetadata":{"title":"Aparna's Personal Space","author":"Aparna Ravindra"}},"markdownRemark":{"id":"857536c8-0c39-5527-8ca2-7509163c4090","excerpt":"I was set out to add a Azure WebJob to my dotnet core project. I already had a dotnet core project that deployed to Azure Webapp using a docker image. I had aâ€¦","html":"<p>I was set out to add a <a href=\"https://learn.microsoft.com/en-us/azure/app-service/webjobs-create?tabs=windowscode\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Azure WebJob</a> to my dotnet core project. I already had a dotnet core project that deployed to Azure Webapp using a docker image. I had a docker file that would get deployed to an Azure Container Registry (or any other docker registry). I also had an ARM template that would then deploy the docker image to an Azure WebApp using ARM template.</p>\n<p>Here is the catch! The official documentation for Azure Webjobs cover the steps to create and deploy the webjobs using visual studio and for dotnet framework console apps. My requirement was to deploy the webjob using a docker image and as a dotnet core console app. At the time of writing this document, there was a warning on the official page that read:\n<code class=\"language-text\">.NET Core Web Apps and/or .NET Core WebJobs can&#39;t be linked with web projects. If you need to deploy your WebJob with a web app, create your WebJobs as a .NET Framework console app.</code></p>\n<p>So, I set out to figure a way out. Here is how I would set things up for a brand new dotnet core project.</p>\n<h3>Prerequisites</h3>\n<ol>\n<li>Docker Desktop should be running</li>\n<li>The example here uses Visual Studio</li>\n</ol>\n<h3>Create a new Dotnet Core project</h3>\n<p><img src=\"https://github.com/user-attachments/assets/af753581-0a1a-4ccc-bfcb-df5324f1de95\" alt=\"newdotnetcorewebproject\"></p>\n<h3>Create another console project in the same solution</h3>\n<p>Create a dotnet core console project to act as your webjob. My solution tree and project structure look like this:</p>\n<p><img src=\"https://github.com/user-attachments/assets/9a1ddba9-8c08-4213-925b-9d9fab8cc655\" alt=\"Solution structure\"></p>\n<p><img src=\"https://github.com/user-attachments/assets/479f2f4b-542b-41aa-ad53-1528d52d478b\" alt=\"Folder View\"></p>\n<h3>Write code for webjob</h3>\n<p>Follow the official document to write the code for the webjob using the <a href=\"https://learn.microsoft.com/en-us/azure/app-service/webjobs-sdk-get-started\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">WebJobs SDK</a>. Additionally, add a Nuget reference to Microsoft.Extensions.Logging.Console for console logging in your webjob.</p>\n<p>Link to an example Program.cs: <a href=\"https://github.com/joshi-aparna/AzureWebAppWithWebJob/blob/master/webjob/Program.cs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/joshi-aparna/AzureWebAppWithWebJob/blob/master/webjob/Program.cs</a>\nLink to an example Function.cs: <a href=\"https://github.com/joshi-aparna/AzureWebAppWithWebJob/blob/master/webjob/Functions.cs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/joshi-aparna/AzureWebAppWithWebJob/blob/master/webjob/Functions.cs</a></p>\n<h3>Add a run.cmd and settings.job file to the webjob project</h3>\n<p>The run.cmd file is executed by the Azure Webjob. The content of this file will simply hold the command to execute the project.\n<code class=\"language-text\">@echo off\ndotnet webjob.dll</code>\nThe settings.job file holds the configuration for the webjob, such as the schedule. Read more <a href=\"https://learn.microsoft.com/en-us/azure/app-service/webjobs-dotnet-deploy-vs#settingsjob-reference\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>. My settings.job file looks like this:\n<code class=\"language-text\">{\n  &quot;schedule&quot;: &quot;0 0 0 * * *&quot;\n}</code>\n<strong>Ensure to include both these files in your project!</strong></p>\n<h3>Let's dockerize!</h3>\n<p>I have ensured in my project structure that the solution file is in the parent folder of both the webapp and webjob projects. Right click on the webapp project -> Add -> Docker support.\nEnsure that you have docker desktop app running.</p>\n<p><strong>Improtant! Set the \"Docker Build Context\" to the parent folder containing both the webapp and webjob projects</strong></p>\n<p><img src=\"https://github.com/user-attachments/assets/ba80da0b-a548-47c5-94c0-956b7ee1bdaf\" alt=\"image\"></p>\n<h3>Add webjob build and deploy steps to the docker file</h3>\n<p>Since the docker build context is set to a folder containing both webapp and webjob projects, you can build and publish the webjob project in the same docker file. Ensure that the webjob project is published to the path <code class=\"language-text\">app_data/jobs/triggered/webjob</code> for triggered webjobs and <code class=\"language-text\">app_data/jobs/continuous/webjob</code> for continuous webjob. Here <code class=\"language-text\">webjob</code> is the name of the webjob.</p>\n<p>After the publish stage of the dotnet core api project, add the following lines</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># This stage is used to build the webjob project\nFROM publish AS publishwebjob\nARG BUILD_CONFIGURATION=Release\nWORKDIR /src\nCOPY [&quot;webjob/webjob.csproj&quot;, &quot;webjob/&quot;]\nRUN dotnet restore &quot;./webjob/webjob.csproj&quot;\nCOPY . .\nWORKDIR &quot;/src/webjob&quot;\nRUN dotnet publish &quot;./webjob.csproj&quot; -c %BUILD_CONFIGURATION% -o /app/publish/app_data/jobs/triggered/webjob /p:UseAppHost=false</code></pre></div>\n<h3>Copy the webjob files to app_data on before service start</h3>\n<p><a href=\"https://learn.microsoft.com/en-us/azure/app-service/webjobs-create?tabs=windowscode#continuous-vs-triggered-webjobs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">This official document</a> says that the files for the webjob need to be in the \\site\\wwwroot\\app_data\\Jobs path. In our docker file, we have set our work directory as /app.\n<code class=\"language-text\">WORKDIR /app</code>\nSo, before starting the application, let us move the webjob files to the required path. To do this, create a file called <code class=\"language-text\">startup.cmd</code> in your webapi project with the following content.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@echo off\nxcopy /s /e /y &quot;C:\\app\\app_data&quot; &quot;C:\\home\\site\\wwwroot\\App_data\\&quot;</code></pre></div>\n<p>Then, in the dockerfile, change the entry point to the following.\n<strong>Notice that the COPY stage is using the \"publishwebjob\" stage for the <code class=\"language-text\">from</code> parameter.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM base AS final\nWORKDIR /app\nCOPY --from=publishwebjob /app/publish .\nENTRYPOINT [&quot;cmd&quot;, &quot;/c&quot;, &quot;startup.cmd &amp;&amp; dotnet coreapp.dll&quot;]</code></pre></div>\n<h3>Publish the coreapp project</h3>\n<p>Right click on the webapi project and select 'Publish'. In this example, I am publishing the image to Azure Container Registry. (Azure -> Azure Container Registry).</p>\n<h3>ARM template</h3>\n<p>I use the following ARM template to deploy the webapp along with the webjob.\nLink to the ARM template: <a href=\"https://github.com/joshi-aparna/AzureWebAppWithWebJob/blob/master/coreapp/deployment/deploy.json\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/joshi-aparna/AzureWebAppWithWebJob/blob/master/coreapp/deployment/deploy.json</a>\n(Note: In the linked ARM template, replace the placeholder values with the right values for your project)</p>\n<p>A few things to remember:</p>\n<ol>\n<li>Set WEBSITES_ENABLE_APP_SERVICE_STORAGE to true</li>\n<li>Set WEBJOBS_IDLE_TIMEOUT appropriately. In my example, I set it to 86400.</li>\n<li>Set \"alwaysOn\" to true</li>\n</ol>\n<p>I create a new resource group on Azure and start deployment of the ARM template using the following command:\n<code class=\"language-text\">az deployment group create --name MyWebAppWithWebjobDeployment --resource-group coreapptest --template-file .\\deploy.json</code></p>\n<p>Navigate to your resouce group -> webapp -> settings -> webjobs to find the deployed webjob. Hit \"Run\" to get started.</p>\n<p><img src=\"https://github.com/user-attachments/assets/3b51e5a0-0553-49c7-a8ad-504fb7812cdf\" alt=\"image\"></p>\n<p><strong>Happy coding :)</strong></p>","fields":{"slug":"/azure_webjob/"},"frontmatter":{"title":"Azure Webjobs - Docker Image and ARM Template","date":"2025, Feb 21","tags":["tech"],"memorydata":null,"practicedata":null,"img":{"childImageSharp":{"resize":{"src":"/static/33f192055d7979ff8d85e792041b42c8/47498/azurewebjob.jpg","height":1200,"width":1200},"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAECBAMF/8QAFwEBAQEBAAAAAAAAAAAAAAAAAwABAv/aAAwDAQACEAMQAAAB9HLbmgwN5jMG1xX/xAAbEAACAwEBAQAAAAAAAAAAAAAAAgEREgMhQf/aAAgBAQABBQJoi2zeDp1Lk058ZYPT/8QAFxEBAAMAAAAAAAAAAAAAAAAAAQAQEf/aAAgBAwEBPwFSYX//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREQ/9oACAECAQE/AVSvf//EABsQAAIDAAMAAAAAAAAAAAAAAAABECExEpHh/9oACAEBAAY/ArZTjEVx6PJ1n//EABwQAQACAwADAAAAAAAAAAAAAAEAESExYVFxgf/aAAgBAQABPyHRR9hWBF+IK7/ZEW6XkdlkKCbqXJhiX//aAAwDAQACAAMAAAAQ99g8/8QAGBEBAQADAAAAAAAAAAAAAAAAAQAQEWH/2gAIAQMBAT8QKau8hj//xAAYEQEBAAMAAAAAAAAAAAAAAAABABAhYf/aAAgBAgEBPxALdyhcf//EAB4QAQEBAAIBBQAAAAAAAAAAAAERACFRMUFhgZHR/9oACAEBAAE/EOE7AYmTSnVmrxFfci4BUdFPnXiUeUX5iEAgrLfvCkJfU4ywEAhzv//Z"},"images":{"fallback":{"src":"/blog/static/33f192055d7979ff8d85e792041b42c8/24f4c/azurewebjob.jpg","srcSet":"/blog/static/33f192055d7979ff8d85e792041b42c8/0f5ce/azurewebjob.jpg 750w,\n/blog/static/33f192055d7979ff8d85e792041b42c8/24f4c/azurewebjob.jpg 1024w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/33f192055d7979ff8d85e792041b42c8/099ee/azurewebjob.avif 750w,\n/blog/static/33f192055d7979ff8d85e792041b42c8/eb314/azurewebjob.avif 1024w","type":"image/avif","sizes":"100vw"},{"srcSet":"/blog/static/33f192055d7979ff8d85e792041b42c8/4f03f/azurewebjob.webp 750w,\n/blog/static/33f192055d7979ff8d85e792041b42c8/67ded/azurewebjob.webp 1024w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}}}}},"pageContext":{"slug":"/azure_webjob/","previous":{"fields":{"slug":"/indistractable/"},"frontmatter":{"title":"Indistractable","tags":["book","non-fiction","habits"],"img":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAMEAQIF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/9oADAMBAAIQAxAAAAHHWqbaCuJnGYxB/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQISIQADEf/aAAgBAQABBQJHZTJQh2ZUOg666FEzTUc//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFREBAQAAAAAAAAAAAAAAAAAAEAL/2gAIAQIBAT8BKP/EABwQAAICAgMAAAAAAAAAAAAAAAABAhESMRAhof/aAAgBAQAGPwK4xsyeuH4YtNmpFDSO0j//xAAbEAEAAwADAQAAAAAAAAAAAAABABEhMUFhcf/aAAgBAQABPyFnUhuxgTXHIBtRRD1LUwOVEK4utiG+CdeAxEtT8n//2gAMAwEAAgADAAAAEPAIQf/EABgRAQADAQAAAAAAAAAAAAAAAAEAEBEx/9oACAEDAQE/EEMMmR4V/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQARMVH/2gAIAQIBAT8QFLX24tv/xAAcEAEAAgIDAQAAAAAAAAAAAAABABEhQTFhcZH/2gAIAQEAAT8QCTgLSy9dwcxeqeedezJw6ARkcKcdqPJSqVpz79uGFduRMQUFsTMdTBq3qO0DbH//2Q=="},"images":{"fallback":{"src":"/blog/static/a5ee1826a32a4bdd08b7df1054a73ab0/24f4c/indistractable.jpg","srcSet":"/blog/static/a5ee1826a32a4bdd08b7df1054a73ab0/0f5ce/indistractable.jpg 750w,\n/blog/static/a5ee1826a32a4bdd08b7df1054a73ab0/24f4c/indistractable.jpg 1024w","sizes":"100vw"},"sources":[{"srcSet":"/blog/static/a5ee1826a32a4bdd08b7df1054a73ab0/4f03f/indistractable.webp 750w,\n/blog/static/a5ee1826a32a4bdd08b7df1054a73ab0/67ded/indistractable.webp 1024w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}}}},"next":null}},"staticQueryHashes":["251720178","764694655"]}